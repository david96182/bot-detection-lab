## Features-capture

### Description

The tool for the capture of information for the detection of bots is the main result of this project. This tool use the open source network protocol analyzer, [Wireshark](https://www.wireshark.org/) , along with the [PyShark](https://pyshark.readthedocs.io/en/latest/) library to capture information about users in a web server and help detect unwanted bots on **network traffic** user using artificial intelligence techniques. **Wireshark** is a great tool for viewing information on the network level and **PyShark** is a great library for interacting with that information via Python scripts. The tool is designed to run all the time and in **real time** obtaining and processing information about the users as fast as possible and saving this information in an external file. The data obtained correspond to those used in the state of the art of bot detection, previously described.

**This version uses the threading library and each network flow is processed in a different thread.**

---

### Description of the modules

capture: The capture module **controls the flow of network traffic capture**. It divides the network packets into the different network flows that are captured depending on the connected users. Each active network flow corresponds to a connected user, so all packets identified from the information it contains that belong to that user are sent to that flow.

packet: The packet module represents a network flow, a network flow represents a connected user. In this module all the network flows captured from the processing of **the information contained in the network packets are processed**. 

settings: The settings module initializes the logger, contains the methods necessary to load the configuration information, and contains the file with the information about the tool **configuration data**.

test: The test module contains useful **scripts that allow you to test certain network protocols** and verify that the tool obtains the correct information for various protocols. These scripts use the scapy library. There are also other scripts that send requests continuously that can be useful to test the performance of the tool.

utils: The utils module contains methods to support the operation of the tool. Some methods for working with threading/multiprocessing libraries.

---

### Description of the generated output files

**capture.pcap**: File generated by the pyshark library containing the information of all network traffic captured. It is defined in the code to save this file. This file can be viewed with Wireshark.

**flow_analysis.bitnetflow**: **Main output file of the tool**, it contains the information obtained from the capture and processing of network packets. This information would be ready to be used with artificial intelligence algorithms to classify users into humans or bots. An example of this file is shown below:

```
StartTime,Dur,Proto,SrcAddr,Sport,DstAddr,Dport,State,sTos,dTos,TotPkts,TotBytes,SrcBytes,Label
2022-11-02 01:24:15.446773,5.001165,TCP,172.18.0.1,53036,172.18.0.3,80,FSA_FSA,0,0,6,412,272,flow=Normal
2022-11-02 01:24:20.841707,0.772478,HTTP,172.18.0.1,47604,172.18.0.3,80,PA_,0,,2,5331,5331,flow=Botnet
2022-11-02 01:24:21.083180,0.587193,TCP,172.18.0.3,80,172.18.0.1,47604,PA_,0,,2,1526,1526,flow=Normal
```

The first line represents the names of each of the features being captured. Each of the bottom lines is a processed network flow generated by a user, which at the network level is a user's session.

**logs**: Log file generated by the tool that contains the logs of the execution flow that are generated.

---

### Installation

First of all, it is assumed that the web service(sample-website) and the bots(moderate-bot) are already configured and running. The tool can be configured on any network, or with any other web service.

1. Set up tool configuration setting in **settings** module:

   - Set network interface name from which to capture network traffic:

     For this you first need to get the name of the network interface of the configured web service or the desired network. As the configured web service runs on Docker, it has a network created. To get the name of this run:

     ```bash
     ip addr
     ```

     Obtain the name of the network interface that matches the IP range of the configured web service.

     Set the interface obtained in the **NETWORK_INTERFACE** parameter in **settings/config.py**.

   - Set the directory and name of the pcap file where all captured network traffic will be stored:

     In **settings/config.py** change **PCAP_FILE** to the desired directory and name (must be pcap format). Example: ~/exampleCapture.pcap.

   - Set directory and name of the log file:

     In **settings/config.py** change **LOG_FILE** with the desired file name and **LOG_PATH** with the desired path. Example:

     LOG_FILE = 'logfile.log'

     LOG_PATH = '/home/bot/logs'

2. Update IPs for the calculation of the **LABEL** feature:

   In **packet** update the IP address ranges depending on the set ones.

   The LABEL feature is only used for testing purposes. In a real environment it would not be used. It is assumed that the IP **.1** which should be localhost is a normal client (Normal Label), the traffic generated between the web server and the database server is background traffic (Background Label), and all webdriver containers are bots (Botnet Label).

3. Update timeout, default set to 15 seconds:

   The waiting time represents the time to wait for new network packets in a network flow. If this timeout occurs, the network flow is terminated. If new network packets are received and the flow has not been terminated, the timeout is restarted. 

   To change the timeout, the **INTERVAL** variable in **packet module** must be changed to the desired value.

4. If you wish to capture a specified number of packets:

   By default packets are captured all the time and the execution is not terminated. In case you want to capture only a certain amount of network packets, change the value of the **packet_count** variable in the **capture module**.

5. Run the tool:

   ```bash
   python main.py
   ```

6. Verify logs:

   ```bash
   tail -f /log_path/log_name.log
   ```

   